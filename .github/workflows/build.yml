name: Android Build (upload first error)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  GRADLE_VERSION: 8.6

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install apt prerequisites
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip wget lib32z1
        shell: bash

      - name: Download Android commandline tools
        run: |
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd /tmp
          wget -q -O cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          if [ -d "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" ]; then
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          fi
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools"
        shell: bash

      - name: Install required SDK packages (platforms + build-tools)
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          SDKMAN="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          if [ ! -f "$SDKMAN" ]; then
            echo "ERROR: sdkmanager not found at $SDKMAN"
            ls -la "$ANDROID_SDK_ROOT/cmdline-tools" || true
            exit 1
          fi
          chmod +x "$SDKMAN" || true
          printf '%s\n' y y y | bash "$SDKMAN" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          bash "$SDKMAN" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-34" "build-tools;34.0.0"
        shell: bash

      - name: Ensure Gradle provided by action (do NOT use wrapper)
        uses: gradle/gradle-build-action@v2
        id: gradle_setup
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}
          use-gradle-wrapper: false

      - name: Run Gradle assembleDebug and save full console to build.log
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -o pipefail
          gradle --version
          gradle assembleDebug --stacktrace --info --no-daemon 2>&1 | tee build.log
          echo "---- EOF OF LOG ----"
          tail -n 200 build.log || true
        shell: bash

      - name: Extract first red error block
        run: |
          # find the first occurrence of "FAIL" or "Caused by" or ": FAILED" - print that line and the following 40 lines
          FIRST_LINE=$(grep -nE "FAIL|: FAILED|Caused by:" build.log | head -n1 | cut -d: -f1 || true)
          if [ -z "$FIRST_LINE" ]; then
            echo "No obvious red markers found, show last 200 lines" > first-error.txt
            tail -n 200 build.log >> first-error.txt
          else
            START=$(( FIRST_LINE - 3 ))
            if [ $START -lt 1 ]; then START=1; fi
            echo "Extracting from line $START" > first-error.txt
            sed -n "${START},$(( FIRST_LINE + 80 ))p" build.log >> first-error.txt
          fi
          echo "--- END ---" >> first-error.txt
          echo "first-error.txt created with size:" >> first-error.txt
          ls -lh first-error.txt >> first-error.txt || true
        shell: bash

      - name: Upload first error snippet
        uses: actions/upload-artifact@v4
        with:
          name: first-error
          path: first-error.txt

      - name: Upload full build log
        uses: actions/upload-artifact@v4
        with:
          name: full-build-log
          path: build.log

      - name: Upload debug APK (if produced)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/*.apk
